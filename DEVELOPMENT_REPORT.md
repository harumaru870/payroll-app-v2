# 📝 給与管理システム (payroll-app-v2) 開発活動報告書

## 1. プロジェクト概要
*   **プロジェクト名**: payroll-app-v2
*   **目的**: 従業員管理、シフト管理、複雑な給与計算（夜勤・昇給対応）、明細書PDF発行を一元管理するWebアプリケーションの開発。
*   **ターゲット**: 小〜中規模の店舗や事業所。

## 2. 技術スタック (Tech Stack)
次回一人で作る際は、これらの技術を組み合わせます。

| カテゴリ | 技術・ライブラリ | 選定理由 |
| :--- | :--- | :--- |
| **Framework** | **Next.js 15 (App Router)** | 現在の標準。サーバー機能と画面構築を統合して開発できるため効率的。 |
| **Language** | **TypeScript** | 型安全性。金額計算などのバグを防ぐために必須。 |
| **Styling** | **Tailwind CSS** | CSSファイルを行き来せず、クラス名だけで素早くデザインするため。 |
| **Database** | **Supabase (PostgreSQL)** | 構築が簡単で、Prismaとの相性が良い。 |
| **ORM** | **Prisma** | DB操作をSQLではなく直感的なコードで書ける。型安全。 |
| **UI Logic** | **React Server Actions** | APIのエンドポイントを作らず、関数を呼ぶ感覚でDB操作ができる。 |
| **Calendar** | **react-calendar** | カレンダーUIの基本機能が揃っている。 |
| **PDF** | **@react-pdf/renderer** | Reactコンポーネントを書く感覚でPDFを作れる。日本語フォント対応が容易。 |
| **Date** | **date-fns** | 日付計算（差分、フォーマット）を簡単にするため。 |

---

## 3. データベース設計 (Schema)
システムの根幹です。`prisma/schema.prisma` で定義しました。

1.  **User (従業員)**: 基本情報（名前、メール）。
2.  **WageSetting (給与設定)**: **【重要】** `effectiveFrom`（適用開始日）を持たせることで、昇給履歴を管理できるようにした（1対多のリレーション）。
3.  **Shift (シフト)**: 日付、開始・終了時間、休憩時間。
4.  **SystemSetting (システム設定)**: 会社名、締め日、デフォルト休憩時間。

---

## 4. 開発ステップ詳細 (Roadmap)

### Step 1: 環境構築
*   `npx create-next-app@latest` でプロジェクト作成。
*   Supabaseでプロジェクト作成。
*   `DATABASE_URL` (Transaction Pooler / 6543) と `DIRECT_URL` (Session Pooler / 5432) を `.env` に設定。
    *   ⚠️ **トラブルシュート**: PrismaとSupabaseの相性問題（Prepared Statementエラー）が発生したため、最終的に **両方ともポート5432** を使用して解決。

### Step 2: 従業員管理機能 (CRUD)
*   **Server Actions (`src/app/actions.ts`)**:
    *   `getEmployees`, `createEmployee`, `updateEmployee` などの関数を作成。
*   **UI**: 一覧画面と登録・編集フォームを作成。

### Step 3: シフト管理機能
*   **カレンダー導入**: `react-calendar` を使用。
*   **UI改善**:
    *   PC/スマホで入力しやすいよう、時間入力に `+` `-` ボタンを設置。
    *   日付選択→従業員選択→時間入力という自然なフローにレイアウト変更。
    *   「シフトが入っている日」の背景色を変える視覚的工夫。

### Step 4: 給与計算ロジック (最難関)
*   **ロジック (`src/utils/payroll.ts`)**:
    *   勤務時間 = (終了 - 開始) - 休憩
    *   **夜勤対応**: 22:00〜翌5:00の時間を判定し、その分だけ時給を1.25倍にする。
*   **時給履歴の適用**:
    *   シフトの日付時点で「有効だった時給」を検索して適用するロジックを実装。
    *   `isBefore` や `startOfDay` を使い、日付判定を厳密化。

### Step 5: PDF出力機能
*   **ライブラリ選定**: 当初 `jspdf` を試したが、フォント周りのトラブル多発。`@react-pdf/renderer` に切り替えて成功。
*   **日本語対応**: `public/fonts/` に `NotoSansJP.woff` を配置し、フォント登録することで文字化けを解消。
*   **レイアウト**: 明細書として通用するよう、ヘッダー、サマリー、詳細テーブルを配置。

### Step 6: システム設定と締め日
*   **締め日対応**: デフォルトの「月末締め」だけでなく、「25日締め」等に対応。
*   **期間計算**: 締め日に基づいて、`calculateMonthlyPayroll` 内で集計開始日と終了日を動的に計算（例: 25日締めなら前月26日〜当月25日）。

---

## 5. 乗り越えた主なエラーと解決策 (Troubleshooting)

| エラー/課題 | 原因 | 解決策 |
| :--- | :--- | :--- |
| **Prisma接続エラー** (`prepared statement ... does not exist`) | SupabaseのTransaction Pooler (6543) がPrismaのプリペアドステートメントに対応していない。 | `.env` の接続先を **Session Pooler (5432)** に変更した。 |
| **時給が正しく適用されない** | 日付比較で「時間（時:分）」まで見てしまい、同日の変更が無視されていた。 | `date-fns` の `startOfDay` を使い、**日付部分のみ**で比較するように修正。 |
| **PDF文字化け** | デフォルトフォントが日本語に対応していない。 | 日本語フォントファイル (`.woff`) をダウンロードし、`Font.register` で読み込ませた。 |
| **設定保存エラー** | レコードがない状態で `update` しようとした。 | レコードがなければ `create`、あれば `update` するロジックに変更し、バリデーションを追加。 |

---

## 6. 次のステップへのアドバイス (Self-Study Guide)

次回、あなたが一人で作る時は以下の順序を意識してみてください。

1.  **データ構造から考える**:
    *   「どんなデータが必要か？」を書き出し、`schema.prisma` を最初にしっかり設計するのが成功の鍵です。
2.  **小さく作って動かす**:
    *   機能ごとに動く状態を確認しながら進めましょう。
3.  **型定義 (TypeScript) をサボらない**:
    *   バグの原因を早期に発見するため、型を定義しましょう。
4.  **AIを「ペアプログラマー」として使う**:
    *   「なぜそのコードで動くのか？」を読み解くことで実力が伸びます。

### 📁 プロジェクト構成
```
payroll-app-v2/
├── prisma/
│   └── schema.prisma       # データベース設計図
├── public/
│   └── fonts/              # PDF用フォント
├── src/
│   ├── app/
│   │   ├── actions.ts      # サーバー側の処理
│   │   ├── employees/      # 従業員管理
│   │   ├── shifts/         # シフト管理
│   │   ├── payroll/        # 給与計算
│   │   └── settings/       # 設定
│   ├── components/
│   │   ├── shifts/         # UIコンポーネント
│   │   └── payroll/        # PDF定義
│   └── utils/
│       └── payroll.ts      # 計算ロジック
└── ...config files
```
